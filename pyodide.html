<html>
<head>
  <meta charset="utf-8">
</head>
<body>

  <label for="file_input">Select EPW file:</label><br>
  <input type="file" id="file_input" name="file_input" onchange="readFile(this)" accept="epw" disabled><br><br>
  <table id="sun_table"></table>

  <script type="text/javascript">
      // set the pyodide files URL (packages.json, pyodide.asm.data etc)
      window.languagePluginUrl = 'https://cdn.jsdelivr.net/pyodide/v0.16.1/full/';
  </script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/pyodide/v0.16.1/full/pyodide.js"></script>
  <script type="text/javascript" src="https://cdnjs.com/libraries/Chart.js"></script>
  <script type="text/javascript">
    languagePluginLoader.then(() => {
      return pyodide.loadPackage(['micropip']);
    }).then(() => {
      return pyodide.runPython('import micropip');
    }).then(() => {
      pyodide.runPython("micropip.install('ladybug-core')");
      document.getElementById("file_input").disabled = false;
    });
  </script>

  <script type="text/javascript">
  var epw_str = null;

  function readFile(input) {
    pythonCode = `
      from js import epw_str
      from ladybug.epw import EPW
      from ladybug.location import Location
      from ladybug.sunpath import Sunpath
      epw = EPW.from_file_string(epw_str)
      location = epw.location
      print(location)
      sp = Sunpath.from_location(location)
    `

    let file = input.files[0];

    let reader = new FileReader();
    reader.readAsText(file);

    reader.onload = function() {
      epw_str = reader.result
      pyodide.runPython(pythonCode)

      var i;
      var values = [];
      for (i = 0; i < 24; i++) {
        var hour = i;
        pyodide.runPython(`sun = sp.calculate_sun(month=6, day=21, hour=${hour})`);
        let sun = pyodide.pyimport('sun');
        values.push([hour, sun.altitude, sun.azimuth]);
      }

      var sunTable = document.getElementById('sun_table');
      sunTable.innerHTML = "";
      let thead = sunTable.createTHead();
      let rhead = thead.insertRow();
      headers = ['Hour', 'Altitude', 'Azimuth'];
      for (let header of headers) {
        let th = document.createElement("th");
        let text = document.createTextNode(header);
        th.appendChild(text);
        rhead.appendChild(th);
      }

      indices = [0, 1, 2];
      for (let value of values) {
        let row = sunTable.insertRow();
        for (i in indices) {
          let cell = row.insertCell();
          let text = document.createTextNode(value[i]);
          cell.appendChild(text);
        }
      }
    }

  };

  </script>

</body>
</html>